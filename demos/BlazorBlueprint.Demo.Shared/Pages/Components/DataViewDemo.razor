@page "/components/dataview"
@using BlazorBlueprint.Demo.Services
@inject MockDataService MockDataService

<PageTitle>Data View Component - Blazor Blueprint</PageTitle>

<div class="space-y-8 max-w-7xl">
    <div class="space-y-3">
        <h1 class="text-4xl font-bold tracking-tight">Data View Component</h1>
        <p class="text-xl text-muted-foreground">
            A flexible data view component with list and grid layouts, sorting, filtering, pagination,
            and optional infinite scroll.
        </p>
    </div>

    <!-- ── Employee Directory – List ──────────────────────────────────────── -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Employee Directory (List)</h2>
            <p class="text-sm text-muted-foreground">
                Use the <code class="bg-muted px-1 py-0.5 rounded">ItemTemplate</code> parameter to control
                item rendering and register <code class="bg-muted px-1 py-0.5 rounded">BbDataViewField</code>
                components inside <code class="bg-muted px-1 py-0.5 rounded">Fields</code> for sort and filter support.
            </p>
        </div>
        <BbDataView TItem="Person" Data="@people" InitialPageSize="5">
            <ItemTemplate Context="person">
                <div class="flex items-center gap-4 rounded-lg border bg-card p-4 hover:bg-accent/50 transition-colors">
                    <BbAvatar>
                        <BbAvatarFallback>@GetInitials(person.Name)</BbAvatarFallback>
                    </BbAvatar>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold truncate">@person.Name</p>
                        <p class="text-xs text-muted-foreground truncate">@person.Email</p>
                        <p class="text-xs text-muted-foreground">@person.Department · @person.Role</p>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <BbBadge Variant="@(person.Status == "Active" ? BadgeVariant.Default : BadgeVariant.Outline)">
                            @person.Status
                        </BbBadge>
                        <span class="text-xs text-muted-foreground">@person.Salary.ToString("C0")</span>
                    </div>
                </div>
            </ItemTemplate>
            <Fields>
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Name)" Header="Name" Sortable Filterable />
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Email)" Header="Email" Filterable />
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Department)" Header="Department" Sortable Filterable />
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Role)" Header="Role" Sortable Filterable />
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Status)" Header="Status" Sortable />
                <BbDataViewField TItem="Person" TValue="int" Property="@(p => p.Salary)" Header="Salary" Sortable />
            </Fields>
        </BbDataView>
        <CodeBlock Source="Components/DataView/basic.txt" />
    </div>

    <!-- ── Product Catalog ────────────────────────────────────────────────── -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Product Catalog</h2>
            <p class="text-sm text-muted-foreground">
                BbDataView isn't limited to tabular data. Here it renders a product catalog with images,
                searchable by name and category, and sortable by price or rating. Use
                <code class="bg-muted px-1 py-0.5 rounded">HeaderContent</code> and
                <code class="bg-muted px-1 py-0.5 rounded">FooterContent</code> for unstyled slot areas
                above and below the view — you own all borders, backgrounds, and spacing.
            </p>
        </div>
        <BbDataView TItem="Product" Data="@products" Layout="DataViewLayout.Grid" InitialPageSize="8"
                    PageSizes="@(new[] { 4, 8, 12, 24 })">
            <HeaderContent>
                <div class="flex items-center justify-between pb-4 border-b">
                    <div>
                        <h2 class="text-lg font-semibold">Our Products</h2>
                        <p class="text-sm text-muted-foreground">@products.Count items · free shipping over $50</p>
                    </div>
                    <BbBadge Variant="BadgeVariant.Secondary">@products.Count(p => p.Stock > 0) in stock</BbBadge>
                </div>
            </HeaderContent>
            <ItemTemplate Context="product">
                <div class="rounded-lg border bg-card overflow-hidden flex flex-col hover:shadow-md transition-shadow">
                    <div class="relative aspect-square overflow-hidden bg-muted">
                        <img src="@product.ImageUrl"
                             alt="@product.Name"
                             class="object-cover w-full h-full transition-transform hover:scale-105 duration-300"
                             loading="lazy" />
                        @if (product.Stock == 0)
                        {
                            <div class="absolute inset-0 bg-background/70 flex items-center justify-center">
                                <span class="text-sm font-medium text-muted-foreground">Out of Stock</span>
                            </div>
                        }
                        else if (product.Stock <= 5)
                        {
                            <div class="absolute top-2 right-2">
                                <BbBadge Variant="BadgeVariant.Destructive">Low stock</BbBadge>
                            </div>
                        }
                    </div>
                    <div class="p-4 flex flex-col gap-2 flex-1">
                        <div class="flex items-start justify-between gap-2">
                            <p class="text-sm font-semibold leading-snug line-clamp-2">@product.Name</p>
                            <BbBadge Variant="BadgeVariant.Outline" Class="shrink-0 text-xs">@product.Category</BbBadge>
                        </div>
                        <div class="flex items-center gap-1">
                            @for (var i = 1; i <= 5; i++)
                            {
                                var star = i;
                                <svg class="@(star <= Math.Round(product.Rating) ? "text-amber-500" : "text-muted-foreground/40") w-3.5 h-3.5 fill-current" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            }
                            <span class="text-xs text-muted-foreground ml-1">@product.Rating.ToString("F1")</span>
                        </div>
                        <div class="flex items-center justify-between mt-auto pt-2 border-t">
                            <span class="text-base font-bold">$@product.Price.ToString("F2")</span>
                            <BbButton Size="ButtonSize.Small"
                                      Variant="@(product.Stock > 0 ? ButtonVariant.Default : ButtonVariant.Outline)"
                                      Disabled="@(product.Stock == 0)">
                                @(product.Stock > 0 ? "Add to Cart" : "Notify Me")
                            </BbButton>
                        </div>
                    </div>
                </div>
            </ItemTemplate>
            <FooterContent>
                <div class="flex items-center justify-between pt-4 border-t text-sm text-muted-foreground">
                    <span>Prices include VAT. Free returns within 30 days.</span>
                    <span>© 2025 Demo Store</span>
                </div>
            </FooterContent>
            <Fields>
                <BbDataViewField TItem="Product" TValue="string" Property="@(p => p.Name)" Header="Name" Sortable Filterable />
                <BbDataViewField TItem="Product" TValue="string" Property="@(p => p.Category)" Header="Category" Sortable Filterable />
                <BbDataViewField TItem="Product" TValue="decimal" Property="@(p => p.Price)" Header="Price" Sortable />
                <BbDataViewField TItem="Product" TValue="double" Property="@(p => p.Rating)" Header="Rating" Sortable />
            </Fields>
        </BbDataView>
        <CodeBlock Source="Components/DataView/product-catalog.txt" />
    </div>

    <!-- ── Header and Footer Slots ────────────────────────────────────────── -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Header &amp; Footer Slots</h2>
            <p class="text-sm text-muted-foreground">
                Use the <code class="bg-muted px-1 py-0.5 rounded">HeaderContent</code> and
                <code class="bg-muted px-1 py-0.5 rounded">FooterContent</code> parameters to render
                custom content above and below the view. The slots are completely unstyled — you own
                every border, background, and spacing choice.
            </p>
        </div>
        <BbDataView TItem="Person" Data="@people" InitialPageSize="4">
            <HeaderContent>
                <div class="flex items-center justify-between rounded-t-lg border border-b-0 bg-card px-6 py-4">
                    <div>
                        <h2 class="text-base font-semibold">Team Members</h2>
                        <p class="text-sm text-muted-foreground">Browse and search your team directory.</p>
                    </div>
                    <BbButton Variant="ButtonVariant.Default" Size="ButtonSize.Small">
                        Add Member
                    </BbButton>
                </div>
            </HeaderContent>
            <ItemTemplate Context="person">
                <div class="flex items-center gap-4 rounded-lg border bg-card p-4">
                    <BbAvatar>
                        <BbAvatarFallback>@GetInitials(person.Name)</BbAvatarFallback>
                    </BbAvatar>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold truncate">@person.Name</p>
                        <p class="text-xs text-muted-foreground truncate">@person.Email</p>
                    </div>
                    <BbBadge Variant="BadgeVariant.Secondary">@person.Department</BbBadge>
                </div>
            </ItemTemplate>
            <FooterContent>
                <div class="rounded-b-lg border border-t-0 bg-muted/30 px-6 py-3 text-sm text-muted-foreground">
                    Showing filtered results from @people.Count total records.
                </div>
            </FooterContent>
            <Fields>
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Name)" Header="Name" Sortable Filterable />
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Department)" Header="Department" Sortable Filterable />
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Email)" Header="Email" Filterable />
            </Fields>
        </BbDataView>
        <CodeBlock Source="Components/DataView/header-footer.txt" />
    </div>

    <!-- ── Infinite Scroll – Product Grid (Load More Button) ──────────────── -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Infinite Scroll – Product Grid</h2>
            <p class="text-sm text-muted-foreground">
                Set <code class="bg-muted px-1 py-0.5 rounded">EnableInfiniteScroll</code> and
                <code class="bg-muted px-1 py-0.5 rounded">ShowLoadMoreButton</code> to progressively
                load items with an explicit button. The button is always rendered outside the grid
                container so it spans the full width regardless of column count — even when the last
                row is partially filled. Sorting or filtering resets to the first batch.
            </p>
        </div>
        <BbDataView TItem="Product" Data="@products" Layout="DataViewLayout.Grid"
                    EnableInfiniteScroll="true" ShowLoadMoreButton="true" InitialPageSize="8">
            <ItemTemplate Context="product">
                <div class="rounded-lg border bg-card overflow-hidden flex flex-col hover:shadow-md transition-shadow">
                    <div class="relative aspect-square overflow-hidden bg-muted">
                        <img src="@product.ImageUrl"
                             alt="@product.Name"
                             class="object-cover w-full h-full transition-transform hover:scale-105 duration-300"
                             loading="lazy" />
                        @if (product.Stock == 0)
                        {
                            <div class="absolute inset-0 bg-background/70 flex items-center justify-center">
                                <span class="text-sm font-medium text-muted-foreground">Out of Stock</span>
                            </div>
                        }
                    </div>
                    <div class="p-4 flex flex-col gap-2 flex-1">
                        <div class="flex items-start justify-between gap-2">
                            <p class="text-sm font-semibold leading-snug line-clamp-2">@product.Name</p>
                            <BbBadge Variant="BadgeVariant.Outline" Class="shrink-0 text-xs">@product.Category</BbBadge>
                        </div>
                        <div class="flex items-center justify-between mt-auto pt-2 border-t">
                            <span class="text-base font-bold">$@product.Price.ToString("F2")</span>
                            <BbButton Size="ButtonSize.Small"
                                      Variant="@(product.Stock > 0 ? ButtonVariant.Default : ButtonVariant.Outline)"
                                      Disabled="@(product.Stock == 0)">
                                @(product.Stock > 0 ? "Add to Cart" : "Notify Me")
                            </BbButton>
                        </div>
                    </div>
                </div>
            </ItemTemplate>
            <Fields>
                <BbDataViewField TItem="Product" TValue="string" Property="@(p => p.Name)" Header="Name" Sortable Filterable />
                <BbDataViewField TItem="Product" TValue="string" Property="@(p => p.Category)" Header="Category" Sortable Filterable />
                <BbDataViewField TItem="Product" TValue="decimal" Property="@(p => p.Price)" Header="Price" Sortable />
                <BbDataViewField TItem="Product" TValue="double" Property="@(p => p.Rating)" Header="Rating" Sortable />
            </Fields>
        </BbDataView>
        <CodeBlock Source="Components/DataView/product-infinite-scroll.txt" />
    </div>

    <!-- ── Infinite Scroll – Auto (scroll-based) ──────────────────────────── -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Infinite Scroll – Auto (scroll-based)</h2>
            <p class="text-sm text-muted-foreground">
                Omit <code class="bg-muted px-1 py-0.5 rounded">ShowLoadMoreButton</code> (or set it to false)
                to use automatic scroll detection. Set
                <code class="bg-muted px-1 py-0.5 rounded">ScrollHeight</code> to any valid CSS height for
                the scroll container — detection works for both flex lists and multi-column grids because
                the container is measured as a whole.
            </p>
        </div>
        <BbDataView TItem="Person" Data="@people" EnableInfiniteScroll="true" ScrollHeight="480px" InitialPageSize="6">
            <ItemTemplate Context="person">
                <div class="flex items-center gap-4 rounded-lg border bg-card p-4 hover:bg-accent/50 transition-colors">
                    <BbAvatar>
                        <BbAvatarFallback>@GetInitials(person.Name)</BbAvatarFallback>
                    </BbAvatar>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold truncate">@person.Name</p>
                        <p class="text-xs text-muted-foreground truncate">@person.Email</p>
                        <p class="text-xs text-muted-foreground">@person.Department · @person.Role</p>
                    </div>
                    <BbBadge Variant="BadgeVariant.Outline">@person.Age yrs</BbBadge>
                </div>
            </ItemTemplate>
            <Fields>
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Name)" Header="Name" Sortable Filterable />
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Role)" Header="Role" Sortable Filterable />
                <BbDataViewField TItem="Person" TValue="int" Property="@(p => p.Age)" Header="Age" Sortable />
            </Fields>
        </BbDataView>
        <CodeBlock Source="Components/DataView/infinite-scroll.txt" />
    </div>

    <!-- ── Loading State ──────────────────────────────────────────────────── -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Loading State</h2>
            <p class="text-sm text-muted-foreground">
                Set <code class="bg-muted px-1 py-0.5 rounded">IsLoading</code> to show a loading indicator
                while data is being fetched. Provide
                <code class="bg-muted px-1 py-0.5 rounded">LoadingTemplate</code> to replace the default
                indicator with skeleton cards or any custom content.
            </p>
        </div>
        <BbButton Variant="ButtonVariant.Outline" Size="ButtonSize.Small" OnClick="@(() => isLoading = !isLoading)">
            Toggle Loading
        </BbButton>
        <BbDataView TItem="Person" Data="@people" IsLoading="@isLoading" InitialPageSize="4">
            <ItemTemplate Context="person">
                <div class="flex items-center gap-4 rounded-lg border bg-card p-4">
                    <BbAvatar><BbAvatarFallback>@GetInitials(person.Name)</BbAvatarFallback></BbAvatar>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold">@person.Name</p>
                        <p class="text-xs text-muted-foreground">@person.Email</p>
                    </div>
                </div>
            </ItemTemplate>
            <Fields>
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Name)" Header="Name" Sortable Filterable />
            </Fields>
        </BbDataView>
        <CodeBlock Source="Components/DataView/loading.txt" />
    </div>

    <!-- ── Empty State ────────────────────────────────────────────────────── -->
    <div class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">Empty State</h2>
            <p class="text-sm text-muted-foreground">
                Displays the default empty state when there are no results. Provide
                <code class="bg-muted px-1 py-0.5 rounded">EmptyTemplate</code> to render a custom state.
            </p>
        </div>
        <BbDataView TItem="Person" Data="@emptyPeople" InitialPageSize="5">
            <ItemTemplate Context="person">
                <div class="rounded-lg border bg-card p-4">@person.Name</div>
            </ItemTemplate>
            <Fields>
                <BbDataViewField TItem="Person" TValue="string" Property="@(p => p.Name)" Header="Name" Filterable />
            </Fields>
        </BbDataView>
        <CodeBlock Source="Components/DataView/empty.txt" />
    </div>

    <!-- ── Accessibility ──────────────────────────────────────────────────── -->
    <AccessibilityList>
        <AriaAttributes>
            <AccessibilityItem>Toolbar search uses a native input with <code>role="searchbox"</code> semantics via BbInput</AccessibilityItem>
            <AccessibilityItem><code>aria-label</code> on layout-toggle buttons describes each mode ("List view", "Grid view")</AccessibilityItem>
            <AccessibilityItem><code>title</code> on sort direction button describes the current sort direction and next action</AccessibilityItem>
            <AccessibilityItem>Empty state uses BbEmpty which renders descriptive text readable by screen readers</AccessibilityItem>
            <AccessibilityItem>Pagination uses BbPagination primitives with full keyboard and ARIA support</AccessibilityItem>
            <AccessibilityItem>Product images carry meaningful <code>alt</code> text derived from the item's name</AccessibilityItem>
            <AccessibilityItem>Avatar fallbacks use text initials readable by screen readers</AccessibilityItem>
        </AriaAttributes>
        <KeyboardNavigation>
            <KeyboardShortcutItem Description="Focus the global search input">
                <BbKbd>Tab</BbKbd>
            </KeyboardShortcutItem>
            <KeyboardShortcutItem Description="Open the sort field dropdown">
                <BbKbd>Enter</BbKbd> / <BbKbd>Space</BbKbd>
            </KeyboardShortcutItem>
            <KeyboardShortcutItem Description="Toggle sort direction">
                <BbKbd>Click</BbKbd>
            </KeyboardShortcutItem>
            <KeyboardShortcutItem Description="Navigate pagination controls">
                <BbKbd>Tab</BbKbd> / <BbKbd>Shift</BbKbd>+<BbKbd>Tab</BbKbd>
            </KeyboardShortcutItem>
            <KeyboardShortcutItem Description="Activate pagination buttons">
                <BbKbd>Enter</BbKbd> / <BbKbd>Space</BbKbd>
            </KeyboardShortcutItem>
        </KeyboardNavigation>
    </AccessibilityList>

    <!-- ── API Reference ──────────────────────────────────────────────────── -->
    <section class="space-y-4">
        <div class="space-y-2">
            <h2 class="text-2xl font-semibold">API Reference</h2>
            <p class="text-muted-foreground">Component parameters and render fragments.</p>
        </div>
        <div class="space-y-4">
            <ApiReference ComponentName="DataView">
                <ApiParameter Name="Data" Type="IEnumerable&lt;TItem&gt;">
                    The data source for the view.
                </ApiParameter>
                <ApiParameter Name="ItemTemplate" Type="RenderFragment&lt;TItem&gt;?">
                    Template used to render each item. The context variable is the data item.
                </ApiParameter>
                <ApiParameter Name="HeaderContent" Type="RenderFragment?" Default="null">
                    Optional unstyled content rendered above the toolbar. You own all styling.
                </ApiParameter>
                <ApiParameter Name="FooterContent" Type="RenderFragment?" Default="null">
                    Optional unstyled content rendered below items and pagination. You own all styling.
                </ApiParameter>
                <ApiParameter Name="Fields" Type="RenderFragment?" Default="null">
                    Container for BbDataViewField definitions (and optional slot components).
                </ApiParameter>
                <ApiParameter Name="Layout" Type="DataViewLayout" Default="List">
                    Layout mode: List or Grid.
                </ApiParameter>
                <ApiParameter Name="ShowToolbar" Type="bool" Default="true">
                    Whether to show the toolbar with search, sort, and layout controls.
                </ApiParameter>
                <ApiParameter Name="ShowPagination" Type="bool" Default="true">
                    Whether to show pagination controls (hidden when EnableInfiniteScroll is true).
                </ApiParameter>
                <ApiParameter Name="IsLoading" Type="bool" Default="false">
                    Whether the view is in a loading state.
                </ApiParameter>
                <ApiParameter Name="InitialPageSize" Type="int" Default="5">
                    Initial page size (also the batch size in infinite scroll mode).
                </ApiParameter>
                <ApiParameter Name="PageSizes" Type="int[]" Default="[5, 10, 20, 50, 100]">
                    Available page size options shown in the pagination size selector.
                </ApiParameter>
                <ApiParameter Name="EnableInfiniteScroll" Type="bool" Default="false">
                    Replaces pagination with progressive item loading. Works for both list and grid.
                </ApiParameter>
                <ApiParameter Name="ShowLoadMoreButton" Type="bool" Default="false">
                    Shows an explicit "Load more" button when EnableInfiniteScroll is true.
                </ApiParameter>
                <ApiParameter Name="ScrollHeight" Type="string?" Default="null">
                    CSS height for the scroll container in auto-scroll mode (e.g. "400px", "60vh").
                    When null, no inline height is set and the container inherits from its parent.
                </ApiParameter>
                <ApiParameter Name="EmptyTemplate" Type="RenderFragment?" Default="null">
                    Custom template for the empty state.
                </ApiParameter>
                <ApiParameter Name="LoadingTemplate" Type="RenderFragment?" Default="null">
                    Custom template for the loading state.
                </ApiParameter>
                <ApiParameter Name="OnSort" Type="EventCallback&lt;(string, SortDirection)&gt;">
                    Invoked when sorting changes.
                </ApiParameter>
                <ApiParameter Name="OnFilter" Type="EventCallback&lt;string?&gt;">
                    Invoked when the global search value changes.
                </ApiParameter>
            </ApiReference>

            <ApiReference ComponentName="DataViewField">
                <ApiParameter Name="Header" Type="string">
                    Display label used in the sort field selector.
                </ApiParameter>
                <ApiParameter Name="Property" Type="Func&lt;TItem, TValue&gt;">
                    Expression to get the field value from a data item.
                </ApiParameter>
                <ApiParameter Name="Sortable" Type="bool" Default="false">
                    Whether items can be sorted by this field.
                </ApiParameter>
                <ApiParameter Name="Filterable" Type="bool" Default="false">
                    Whether this field participates in global search filtering.
                </ApiParameter>
            </ApiReference>
        </div>
    </section>
</div>

@code {
    private List<Person> people = new();
    private List<Person> emptyPeople = new();
    private List<Product> products = new();
    private bool isLoading;

    protected override void OnInitialized()
    {
        people = MockDataService.GeneratePersons(500);
        products = MockDataService.GenerateProducts(60);
    }

    private static string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length >= 2
            ? $"{parts[0][0]}{parts[^1][0]}"
            : name.Length > 0 ? name[0].ToString() : "?";
    }
}
