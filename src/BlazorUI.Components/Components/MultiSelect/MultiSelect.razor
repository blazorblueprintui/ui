@namespace BlazorUI.Components.MultiSelect
@typeparam TItem
@using BlazorUI.Components.Popover
@using BlazorUI.Primitives.Services

<div class="@ContainerClass">
    <Popover @bind-Open="_isOpen">
        <PopoverTrigger role="combobox"
                        aria-expanded="@_isOpen.ToString().ToLower()"
                        aria-controls="@($"{Id}-listbox")"
                        aria-haspopup="listbox"
                        aria-multiselectable="true"
                        disabled="@Disabled"
                        class="@TriggerCssClass">
            <div class="flex flex-wrap items-center gap-1 flex-1 min-w-0">
                @if (HasSelectedItems)
                {
                    @foreach (var value in SelectedValues.Take(MaxDisplayTags))
                    {
                        <span class="@TagCssClass">
                            @GetDisplayText(value)
                            <button type="button"
                                    class="@TagRemoveButtonCssClass"
                                    aria-label="@($"Remove {GetDisplayText(value)}")"
                                    @onclick="@(() => RemoveValue(value))"
                                    @onclick:stopPropagation="true">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3 w-3">
                                    <path d="M18 6 6 18" /><path d="m6 6 12 12" />
                                </svg>
                            </button>
                        </span>
                    }
                    @if (OverflowCount > 0)
                    {
                        <span class="text-xs text-muted-foreground">+@OverflowCount more</span>
                    }
                }
                else
                {
                    <span class="text-muted-foreground">@Placeholder</span>
                }
            </div>
            <div class="flex items-center gap-1 ml-2">
                @if (HasSelectedItems)
                {
                    <button type="button"
                            class="rounded-sm opacity-70 hover:opacity-100 focus:outline-none focus:ring-1 focus:ring-ring"
                            aria-label="Clear all"
                            @onclick="ClearAll"
                            @onclick:stopPropagation="true">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3.5 w-3.5">
                            <path d="M18 6 6 18" /><path d="m6 6 12 12" />
                        </svg>
                    </button>
                }
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4 shrink-0 opacity-50">
                    <path d="m6 9 6 6 6-6" />
                </svg>
            </div>
        </PopoverTrigger>

        <PopoverContent Side="@PopoverSide.Bottom"
                        Align="@PopoverAlign.Start"
                        CloseOnClickOutside="false"
                        CloseOnEscape="false"
                        Class="@($"{PopoverWidth} !p-0")">
            @* Search input section *@
            <div class="flex items-center border-b border-border px-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4 shrink-0 opacity-50">
                    <circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" />
                </svg>
                <input @ref="_searchInputRef"
                       id="@($"{Id}-search")"
                       type="text"
                       placeholder="@SearchPlaceholder"
                       value="@_searchQuery"
                       @oninput="HandleSearchInput"
                       class="flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50" />
            </div>

            @* Items list section *@
            <div id="@($"{Id}-listbox")" role="listbox" aria-multiselectable="true" class="max-h-[300px] overflow-y-auto p-1">
                @if (!HasFilteredItems)
                {
                    <div class="py-6 text-center text-sm text-muted-foreground">@EmptyMessage</div>
                }
                else
                {
                    @* Select All option *@
                    @if (ShowSelectAll)
                    {
                        var selectAllState = GetSelectAllState();
                        <div role="option"
                             aria-selected="@(selectAllState == SelectAllState.All ? "true" : "false")"
                             @onclick="HandleSelectAllToggle"
                             @onclick:stopPropagation="true"
                             class="@ItemCssClass">
                            @* Simple checkbox indicator - no button element *@
                            <div class="@(selectAllState != SelectAllState.None ? CheckboxCheckedCssClass : CheckboxUncheckedCssClass) flex items-center justify-center">
                                @if (selectAllState == SelectAllState.All)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3.5 w-3.5">
                                        <path d="M20 6 9 17l-5-5" />
                                    </svg>
                                }
                                else if (selectAllState == SelectAllState.Indeterminate)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3.5 w-3.5">
                                        <path d="M5 12h14" />
                                    </svg>
                                }
                            </div>
                            <span class="font-medium">@SelectAllLabel</span>
                        </div>
                        <div class="my-1 h-px bg-border" role="separator"></div>
                    }

                    @* Individual items *@
                    @foreach (var item in FilteredItems)
                    {
                        var itemValue = ValueSelector(item);
                        var displayText = DisplaySelector(item);
                        var isSelected = IsSelected(item);

                        <div role="option"
                             aria-selected="@isSelected.ToString().ToLower()"
                             @onclick="@(() => HandleToggle(item))"
                             @onclick:stopPropagation="true"
                             class="@ItemCssClass">
                            @* Simple checkbox indicator - no button element *@
                            <div class="@(isSelected ? CheckboxCheckedCssClass : CheckboxUncheckedCssClass) flex items-center justify-center">
                                @if (isSelected)
                                {
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-3.5 w-3.5">
                                        <path d="M20 6 9 17l-5-5" />
                                    </svg>
                                }
                            </div>
                            <span>@displayText</span>
                        </div>
                    }
                }
            </div>

            @* Footer section *@
            <div class="flex items-center justify-between border-t p-2">
                <button type="button"
                        class="text-xs text-muted-foreground hover:text-foreground transition-colors"
                        @onclick="ClearAll"
                        @onclick:stopPropagation="true">
                    @ClearLabel
                </button>
                <button type="button"
                        class="text-xs text-muted-foreground hover:text-foreground transition-colors"
                        @onclick="Close"
                        @onclick:stopPropagation="true">
                    @CloseLabel
                </button>
            </div>
        </PopoverContent>
    </Popover>
</div>
