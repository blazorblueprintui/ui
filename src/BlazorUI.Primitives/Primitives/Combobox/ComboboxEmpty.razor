@namespace BlazorUI.Primitives.Combobox
@implements IDisposable

@* ComboboxEmpty primitive - headless empty state *@
@if (_shouldShow)
{
    <div @attributes="AdditionalAttributes">
        @ChildContent
    </div>
}

@code {
    [CascadingParameter]
    public ComboboxContext Context { get; set; } = null!;

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional attributes to apply to the empty state element.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private bool _shouldShow;

    protected override void OnInitialized()
    {
        if (Context == null)
        {
            throw new InvalidOperationException($"{nameof(ComboboxEmpty)} must be used within a {nameof(Combobox)} component.");
        }

        // Subscribe to context state changes
        Context.OnStateChanged += HandleContextStateChanged;
    }

    protected override void OnParametersSet()
    {
        // Check visibility after all components have initialized
        // This ensures ComboboxItem components have registered before we check if empty
        UpdateShouldShow();
    }

    private void HandleContextStateChanged()
    {
        UpdateShouldShow();
        StateHasChanged();
    }

    private void UpdateShouldShow()
    {
        // Show empty state when there's a search query but no filtered results
        var filteredItems = Context.GetFilteredItems();
        _shouldShow = !string.IsNullOrEmpty(Context.SearchQuery) && filteredItems.Count == 0;
    }

    public void Dispose()
    {
        if (Context != null)
        {
            Context.OnStateChanged -= HandleContextStateChanged;
        }
    }
}
